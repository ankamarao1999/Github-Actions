name: Deploy Frontend (Main + Tag + Auto Tag 12hr)

on:
  push:
    branches:
      - main
    tags:
      - 'release-*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      APP_DIR: /home/frontenduser/Github-Actions

    steps:

      # ------------------------------------------------------------
      # STEP 1 â€” Checkout Code
      # ------------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # STEP 2 â€” Setup SSH
      # ------------------------------------------------------------
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config

      # ------------------------------------------------------------
      # STEP 3 â€” Deploy (Branch or Tag Based)
      # ------------------------------------------------------------
      - name: Deploy on Azure VM
        run: |
          ssh -i ~/.ssh/id_ed25519 \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << ENDSSH

            set -e
            cd /home/frontenduser/Github-Actions
            git fetch --all --tags

            if [ "${{ github.ref_type }}" = "tag" ]; then
              echo "ðŸš€ Deploying TAG: ${{ github.ref_name }}"
              git checkout ${{ github.ref_name }}
            else
              echo "ðŸš€ Deploying MAIN branch"
              git checkout main
              git pull origin main
            fi

            echo "ðŸ§¹ Cleaning old build..."
            rm -rf node_modules dist

            echo "ðŸ“¦ Installing dependencies..."
            npm install

            echo "ðŸ— Building frontend..."
            npm run build

            echo "ðŸ” Restarting PM2..."
            if pm2 describe frontend > /dev/null 2>&1; then
              pm2 restart frontend
            else
              pm2 start serve --name frontend -- -s dist -l 3000
            fi

            pm2 save

            echo "âœ… Deployment Completed"

          ENDSSH

      # ------------------------------------------------------------
      # STEP 4 â€” Auto Create Tag (Only for Main Push)
      # ------------------------------------------------------------
      - name: Create 12hr ISO Tag After Successful Main Deployment
        if: success() && github.ref_type == 'branch'
        run: |
          TAG_NAME="release-$(date -u +'%Y-%m-%dT%I-%M-%S-%p')"

          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git tag $TAG_NAME
          git push origin $TAG_NAME

          echo "âœ… Tag Created: $TAG_NAME"